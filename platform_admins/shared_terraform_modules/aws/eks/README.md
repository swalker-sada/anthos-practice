# Terraform AWS EKS Module
This module creates an EKS cluster in AWS and deploys Anthos Config Management [(ACM)](https://cloud.google.com/anthos/config-management) with [Policy Controller](https://cloud.google.com/anthos-config-management/docs/how-to/installing-policy-controller) enabled on the cluster. 

This module is intended to be used in lab/workshop environments only. The module locks certain parameters that are not exposed to the user as variables, for example, number and type of nodes. The following opinions are baked into this module.
  - Kubernetes version is set to `1.17` release channel. 
  - EKS cluster is created in a single zone.
  - EKS cluster name is autogenerated based on environment, region, zone and a suffix (see inputs for details)
  - The Pod and Service IP ranges are inferred from the `subnet_name` and the `suffix` input values (see input for details).
  - A single node-pool is created with `3` nodes of `t3.2xlarge` type.
  - A `git-creds` secret is created from the SSH private key in the `config-management-system` namespace for ACM. More details can be found [here](https://cloud.google.com/anthos-config-management/docs/how-to/installing#git-creds-secret).
  - The following labels are added to the cluster:
  ```
    "infra"     : "aws"
    "environ"   : "${ENV}"
    "mesh_id"   : "proj-${ENV}-${PROJECT_NUMBER}"
  ```

### Pod and Service IP ranges
TBD

### Cluster name
EKS cluster names are autogenerated based on environment, region, zone and a suffix. It takes the following form.
```bash
"eks-${local.env}-${local.region}${local.zone}-${local.suffix}"
```

## Compatibility
This module is meant for use with Terraform 0.12.

## Usage
Following example is taken from the [/infrastructure/prod/gcp/gke](/infrastructure/prod/aws/eks) folder.
```bash
module "eks_prod_1" {
    source = "../../../../platform_admins/shared_terraform_modules/aws/eks/"
    subnet = data.terraform_remote_state.prod_aws_vpc.outputs.subnets["${var.eks1_subnet_name}"]
    suffix = var.gke1_suffix
    zone = var.gke1_zone
    env = var.env
    acm_ssh_auth_key = data.terraform_remote_state.prod_aws_ssh_key.outputs.private_key
    acm_sync_repo = "git@gitlab.endpoints.${data.terraform_remote_state.prod_aws_vpc.outputs.project_id}.cloud.goog:platform-admins/anthos-config-management.git"
}
```

## Inputs
| **Name** | **Description** | **Type** | **Default** | **Required** |
| ---      | ---             | ---      | ---         | ---          |
| `subnet` | Object of the subnet to be used for the EKS cluster. See below for the spec | object | "" | yes |
| `suffix` | A number from 1 to the number of secondary_ranges in the subnet | number | null | yes |
| `env` | Environment (dev, stage or prod) | string | "" | yes |
| `zone` | Zone where the cluster is created | string | "" | yes |
| `acm_ssh_auth_key` | Value of the SSH private key to be used as the `git-creds` secret in the `config-management-system` namespace for ACM | string | "" | yes |
| `acm_sync_repo` | SSH link of the `anthos-config-management` repo | string | "" | yes |

### Subnet
It is recommended (though not required) to get the `subnet` input variable from the output of the VPC module using the `subnet_name`.
In the example above, you can see the `subnet` variable is defined from the VPC `terraform_remote_state` of the `subnet_name`.

The `subnet` object received from the VPC output is as follows:
```bash
variable "subnet" {
    type = object({
        creation_timestamp = string
        description = string
        gateway_address = string
        id = string
        ip_cidr_range = string
        name = string
        network = string
        private_ip_google_access = string
        project = string
        region = string
        secondary_ip_range = list(object({
            ip_cidr_range = string
            range_name = string
        }))
        self_link = string
    })
}
```

## Outputs
| **Name** | **Description** |
| --- | --- |
| name | Cluster name |
| location | Cluster zone |
| endpoint | Cluster API endpoint |

## Requirements
### Software Dependencies
#### Kubectl
- [kubectl](https://github.com/kubernetes/kubernetes/releases) 1.9.x
#### Terraform and Plugins
- [Terraform](https://www.terraform.io/downloads.html) 0.12
- [Terraform Provider for GCP][terraform-provider-google] v2.9

### IAM Permissions and Credentials
[Minimum IAM permissions needed to setup EKS Cluster](https://github.com/terraform-aws-modules/terraform-aws-eks/blob/master/docs/iam-permissions.md)

- Set GCP and AWS credentials. Get the value of the GCP Project ID, AWS Access Key ID and AWS Secret Access
  Key from Qwiklabs and replace the values with your values below.

```
export GOOGLE_PROJECT=[GCP PROJECT ID]
export AWS_ACCESS_KEY_ID=[AWS_ACCESS_KEY_ID]
export AWS_SECRET_ACCESS_KEY=[AWS_SECRET_ACCESS_KEY]
```
