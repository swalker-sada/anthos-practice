## Objective

Add a new Google Kubernetes Engine or Amazon Kubernetes Service cluster to multi-cloud environment

## Prerequisite

1. Familiarity with Terraform
1. Familiarity with this repository

## Add a new cluster

Adding a new cluster requires additions in a few places, this document provides guidance regarding required modifications

### Add a GKE cluster

1. Depending on the environment (`dev`, `stage`, or `prod`) edit follwing files

* `infrastructure/{ENV}/gcp/gke/main.tf` 
* `infrastructure/{ENV}/gcp/gke/outputs.tf`
* `infrastructure/{ENV}/variables/gke_variables.tf`

<details>
<summary> <b> Sample Modification: </b> </summary>

* `main.tf`

```terraform
module "gke-prod-11" {
    source = "../../../../platform_admins/shared_terraform_modules/gcp/gke/"
    subnet = data.terraform_remote_state.prod_gcp_vpc.outputs.subnets["${var.gke-prod-11_subnet_name}"]
    suffix = var.gke-prod-11_suffix
    zone = var.gke-prod-11_zone
    env = var.env
    acm_ssh_auth_key = data.terraform_remote_state.prod_gcp_ssh_key.outputs.private_key
    acm_sync_repo = "git@gitlab.endpoints.${data.terraform_remote_state.prod_gcp_vpc.outputs.project_id}.cloud.goog:platform-admins/anthos-config-management.git"
    hub_sa_private_key  = data.terraform_remote_state.prod_gcp_hub_gsa.outputs.private_key
    name = "gke-prod-11"
}
```

* `outputs.tf`
```terraform
[START:variables:gke-prod-11]
output "gke-prod-11_name" { value = "${module.gke-prod-11.name}" }
output "gke-prod-11_location" { value = "${module.gke-prod-11.location}" }
output "gke-prod-11_endpoint" { value = "${module.gke-prod-11.endpoint}" }
#[END:variables:gke-prod-11]
```

* `gke_variables.tf`
```terraform
#[START:variables:gke-prod-11]
variable "gke-prod-11_subnet_name" {
    type = string
    default = "us-west2/prod-gcp-vpc-01-us-west2-subnet-01"
}

variable "gke-prod-11_region" {
    type = string
    default = "us-west2"
}

variable "gke-prod-11_suffix" {
    type = number
    default = 1
}

variable "gke-prod-11_zone" {
    type = string
    default = "a"
}
#[END:variables:gke-prod-11]
```
</details>


### Add an EKS cluster
1. Depending on the environment (`dev`, `stage`, or `prod`) edit follwing files

* `infrastructure/{ENV}/aws/eks/main.tf` 
* `infrastructure/{ENV}/aws/eks/outputs.tf`
* `infrastructure/{ENV}/variables/eks_variables.tf`

<details>
<summary> <b> Sample Modification: </b> </summary>

* `main.tf`

```terraform
#[START:eks-prod-11]
module "eks-prod-11" {
    source = "../../../../platform_admins/shared_terraform_modules/aws/eks/"
    eks_cluster_name = var.eks-prod-11
    vpc_id = data.terraform_remote_state.prod_aws_vpc.outputs.id
    private_subnets = data.terraform_remote_state.prod_aws_vpc.outputs.private_subnets
    project_id = data.terraform_remote_state.prod_gcp_vpc.outputs.project_id
    env = var.env
    repo_url = "git@gitlab.endpoints.${data.terraform_remote_state.prod_gcp_vpc.outputs.project_id}.cloud.goog:platform-admins/anthos-config-management.git"
}
#[START:eks-prod-11]
```

* `outputs.tf`
```terraform
[START:variables:eks-prod-11]
output "eks11_cluster_id" {
  description = "eks11 cluster name"
  value       = module.eks_prod_2.cluster_id
}

output "eks11_cluster_endpoint" {
  description = "Endpoint for EKS control plane."
  value       = module.eks_prod_2.cluster_endpoint
}

output "eks11_cluster_security_group_id" {
  description = "Security group ids attached to the cluster control plane."
  value       = module.eks_prod_2.cluster_security_group_id
}

output "eks11_kubectl_config" {
  description = "kubectl config as generated by the module."
  value       = module.eks_prod_2.kubeconfig
}

output "eks11_config_map_aws_auth" {
  description = "A kubernetes configuration to authenticate to this EKS cluster."
  value       = module.eks_prod_2.config_map_aws_auth
}
#[END:variables:eks-prod-11]
```

* `eks_variables.tf`
```terraform
#[START:variables:eks-prod-11]
variable "eks2_cluster_name" { default = "eks-prod-us-west2ab-2" }
#[END:variables:eks-prod-11]
```
</details>

2. Format and validate your changes with

```bash
find . -type f -name '*.tf' -exec terraform fmt {} \;
find . -type f -name '*.tf' -exec terraform validate {} \;
```

3. Run `build.sh` per setup instructions



## Validate configuration and apply changes

Format and validate your changes with

```bash
find . -type f -name '*.tf' -exec terraform fmt {} \;
find . -type f -name '*.tf' -exec terraform validate {} \;
```

3. Run `build.sh` per setup instructions
